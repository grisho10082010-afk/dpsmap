<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ä—Ç–∞</title>

  <!-- Leaflet CDN -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

  <link rel="stylesheet" href="./styles.css" />
</head>
<body>

  <header class="topbar">
    <div class="brand">–ö–∞—Ä—Ç–∞</div>

    <button class="btn" id="btnCity">–ü–æ–∫–∞–∑–∞—Ç—å –≥–æ—Ä–æ–¥</button>
    <button class="btn" id="btnMyLoc">–ú–æ—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è</button>

    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  </header>

  <main id="map"></main>

  <script>
    const statusEl = document.getElementById("status");
    const setStatus = (t) => statusEl.textContent = t;

    // ‚úÖ –ü–æ—Å—Ç–∞–≤—å —Ç—É—Ç —Ü–µ–Ω—Ç—Ä ‚Äú—Ç–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞‚Äù
    const CITY_CENTER = [54.836, 37.61]; // –ø—Ä–∏–º–µ—Ä
    const CITY_ZOOM = 12;

    let map;
    let myMarker = null;
    let myCircle = null;

    function initMap() {
      if (!window.L) {
        setStatus("Leaflet –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è");
        alert("Leaflet –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/–±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏.");
        return;
      }

      map = L.map("map").setView(CITY_CENTER, CITY_ZOOM);

      // –û—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π (OSM)
      const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      });

      // –ó–∞–ø–∞—Å–Ω–æ–π —Å–ª–æ–π (Carto) ‚Äî –∏–Ω–æ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç, –µ—Å–ª–∏ OSM –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
      const carto = L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap &copy; CARTO"
      });

      osm.addTo(map);

      L.control.layers(
        { "OSM": osm, "CARTO": carto },
        {},
        { position: "topright" }
      ).addTo(map);

      setStatus("–ì–æ—Ç–æ–≤–æ ‚úÖ");
    }

    function showCity() {
      if (!map) return;
      map.setView(CITY_CENTER, CITY_ZOOM);
      setStatus("–ü–æ–∫–∞–∑–∞–Ω –≥–æ—Ä–æ–¥");
    }

    function showMyLocation() {
      if (!map) return;

      if (!navigator.geolocation) {
        setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
        alert("–í —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
        return;
      }

      setStatus("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é‚Ä¶");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const acc = pos.coords.accuracy;

          // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ—Ç–º–µ—Ç–∫–∏
          if (myMarker) map.removeLayer(myMarker);
          if (myCircle) map.removeLayer(myCircle);

          myMarker = L.marker([lat, lon]).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å üìç");
          myCircle = L.circle([lat, lon], { radius: acc }).addTo(map);

          map.setView([lat, lon], 15);
          setStatus(`–ì–µ–æ–ø–æ–∑–∏—Ü–∏—è: ${lat.toFixed(5)}, ${lon.toFixed(5)} (¬±${Math.round(acc)}–º)`);
          myMarker.openPopup();
        },
        (err) => {
          console.log(err);
          if (err.code === 1) {
            setStatus("–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω");
            alert("–†–∞–∑—Ä–µ—à–∏ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.");
          } else if (err.code === 2) {
            setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é");
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é. –ü—Ä–æ–≤–µ—Ä—å GPS/–∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
          } else {
            setStatus("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏");
            alert("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏.");
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 12000,
          maximumAge: 0
        }
      );
    }

    window.addEventListener("load", () => {
      initMap();

      document.getElementById("btnCity").addEventListener("click", showCity);
      document.getElementById("btnMyLoc").addEventListener("click", showMyLocation);
    });
  </script>

</body>
</html>
